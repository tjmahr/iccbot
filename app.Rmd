---
title: ICC Bot
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: yeti
    source_code: https://github.com/tjmahr/iccbot
runtime: shiny
bibliography: refs.bib
csl: apa.csl
---

```{r setup, include=FALSE}
library(tidyverse)
library(flexdashboard)
library(shiny)
library(irr)

# Default dataset
data(anxiety, package = "irr")
d <- anxiety

getData <- function() {
  if (is.null(input$file1)) {
    anxiety
  } else {
    read.csv(input$file1$datapath)
  }
}

runICC <- function() {
  req(input$nway)
  
  model <- ifelse(input$nway == "yes", "twoway", "oneway")
  
  add_formatted_results_to_icc(
    icc(
      getData(),
      model = model
      
    )
  )
}

add_formatted_results_to_icc <- function(icc, icc_digits = 3) {
  icc$lbound_p <- icc$lbound %>% 
    printy::fmt_fix_digits(icc_digits) %>% 
    printy::fmt_leading_zero()
  
  icc$ubound_p <- icc$ubound %>% 
    printy::fmt_fix_digits(icc_digits) %>% 
    printy::fmt_leading_zero()
  
  icc$value <- icc$value %>% 
    printy::fmt_fix_digits(icc_digits) %>% 
    printy::fmt_leading_zero()
  
  icc$model_p <- ifelse(
    icc$model == "twoway", 
    "two-way", 
    "one-way"
  )
  
  icc$unit_p <- ifelse(
    icc$unit == "single", 
    "single-score", 
    "mean-score"
  )
  
  icc$type_p <- ifelse(
    icc$type == "consistency", 
    "consistency-based agreement", 
    "absolute agreement"
  )
  
  icc
}


```



Inputs {.sidebar}
-----------------------------------------------------------------------

Upload a csv file of scores with one column per rater and no other columns.

```{r, echo = FALSE}
fileInput(
  "file1", 
  "Choose CSV File", 
  accept = c(
    "text/csv",
    "text/comma-separated-values,text/plain",
    ".csv")
)

selectInput(
  "nway",
  label = "Are the raters members of a larger pool of possible raters?", 
  choices = c("yes", "no"), 
  multiple = FALSE 
)


selectInput(
  "agreement",
  label = "Do you want to estimate agreement of raters or consistency of raters? ", 
  choices = c("absolute-agreement", "consistency"),
  multiple = FALSE 
)
```

<small>If rater A gives three students grades of D, C-, C and rater B gives the same students C-, B-, B+, they would be consistent but they would not agreement. </small>

Column {data-width=400}
-----------------------------------------------------------------------


### ICC Bot says

We calculated the interrater reliability of [*instrument name*] with the
intraclass correlation coefficient (ICC) estimated using the irr R package
[vers. `r packageVersion("irr")`; @R-irr]. Each of the
`r renderText(runICC()[["subjects"]])` participants were scored by
`r renderText(runICC()[["raters"]])` raters.

We used a `r renderText(runICC()[["unit_p"]])`, `r renderText(runICC()[["type_p"]])`,
`r renderText(runICC()[["model_p"]])` random effects model, and we found
`_________` agreement among raters, ICC =
`r renderText(runICC()[["value"]])`, 95% CI =
[`r renderText(runICC()[["lbound_p"]])`,
`r renderText(runICC()[["ubound_p"]])`].

***

<div id="refs"></div>

Column {data-width=450}
-----------------------------------------------------------------------


### ICC print out

```{r}
renderPrint(runICC())
```

### First six rows of data

```{r}
renderPrint(head(getData()))
```
