---
title: ICC Bot
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    theme: yeti
    source_code: https://github.com/tjmahr/iccbot
    md_extensions: "-tex_math_single_backslash"
runtime: shiny
bibliography: refs.bib
csl: apa.csl
---

```{r setup, include = FALSE}
library(tidyverse)
library(flexdashboard)
library(shiny)
library(irr)


# Default dataset
data(anxiety, package = "irr")
d <- anxiety

getData <- function() {
  if (is.null(input$file1)) {
    anxiety
  } else {
    read.csv(input$file1$datapath)
  }
}

usesTwoWayModel <- function() {
  req(input$use_twoway_model)
  input$use_twoway_model == "yes"
}

runICC <- function() {
  req(input$use_twoway_model)
  req(input$single_or_average)
  req(input$agreement_or_consistency)
  
  model <- ifelse(input$use_twoway_model == "yes", "twoway", "oneway")
  unit  <- ifelse(input$single_or_average == "single", "single", "average")
  type <- ifelse(
    input$agreement_or_consistency == "absolute agreement", 
    "agreement", 
    "consistency"
  )
  
  add_formatted_results_to_icc(
    icc(
      getData(),
      model = model,
      unit = unit
      
    )
  )
}


add_formatted_results_to_icc <- function(icc, icc_digits = 3) {
  icc$lbound_p <- icc$lbound %>% 
    printy::fmt_fix_digits(icc_digits) %>% 
    printy::fmt_leading_zero()
  
  icc$ubound_p <- icc$ubound %>% 
    printy::fmt_fix_digits(icc_digits) %>% 
    printy::fmt_leading_zero()
  
  icc$value <- icc$value %>% 
    printy::fmt_fix_digits(icc_digits) %>% 
    printy::fmt_leading_zero()
  
  icc$model_p <- ifelse(
    icc$model == "twoway", 
    "two-way", 
    "one-way"
  )
  
  icc$unit_p <- ifelse(
    icc$unit == "single", 
    "single-score", 
    "mean-score"
  )
  
  icc$type_p <- ifelse(
    icc$type == "consistency", 
    "consistency-based agreement", 
    "absolute agreement"
  )
  
  icc
}


```


Column {.sidebar}
======================================================================

Upload a csv file of scores with one column per rater and no other columns.

```{r, echo = FALSE}
fileInput(
  "file1", 
  "Choose CSV File", 
  accept = c(
    "text/csv",
    "text/comma-separated-values,text/plain",
    ".csv")
)

selectInput(
  "use_twoway_model",
  label = "Are the raters members of a larger pool of possible raters?", 
  choices = c("yes", "no"), 
  multiple = FALSE 
)


selectInput(
  "single_or_average",
  label = "Do you want the reliability for a single rating or the reliability for the average rating?", 
  choices = c("single", "average"),
  multiple = FALSE 
)



renderUI({
  req(input$use_twoway_model)
  
  choices <- if (input$use_twoway_model == "no") {
    c("consistency")
  } else {
    c("absolute agreement", "consistency")
  }
  
  label <- if (input$use_twoway_model == "no") {
    HTML("<s>Do you want to estimate agreement of raters or consistency of raters?</s> Agreement is not available for oneway models.")
    
  } else {
    "Do you want to estimate agreement of raters or consistency of raters?"
  }
  
  selectInput(
    "agreement_or_consistency",
    label = label, 
    choices = choices,
    multiple = FALSE
  )
})


```

***

<small>Developed by TJ Mahr for <a href="https://kidspeech.wisc.edu/" target="_blank">The WISC Lab</a>.</small>

Run ICC Bot
======================================================================


Column {data-width=400}
-----------------------------------------------------------------------


### ICC Bot says

We calculated the interrater reliability of [*instrument name*] with the
intraclass correlation coefficient (ICC) estimated using the irr R package
[vers. `r packageVersion("irr")`; @R-irr]. Each of the
`r renderText(runICC()[["subjects"]])` participants were scored by
`r renderText(runICC()[["raters"]])` raters.

We used a `r renderText(runICC()[["unit_p"]])`, `r renderText(runICC()[["type_p"]])`,
`r renderText(runICC()[["model_p"]])` random effects model, and we found
`_________` agreement among raters, ICC =
`r renderText(runICC()[["value"]])`, 95% CI =
[`r renderText(runICC()[["lbound_p"]])`,
`r renderText(runICC()[["ubound_p"]])`].

***

<div id="refs"></div>


Column {data-width=450}
-----------------------------------------------------------------------


### ICC printout

```{r}
renderPrint(runICC())
```

### First six rows of data

```{r}
renderPrint(head(getData()))
```



What is the ICC?
======================================================================



```{r, child="test.md"}
```
